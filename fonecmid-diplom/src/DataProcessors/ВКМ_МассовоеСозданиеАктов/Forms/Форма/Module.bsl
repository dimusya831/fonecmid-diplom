
&НаКлиенте
Процедура ОбработкаОповещения(ИмяСобытия, Параметр, Источник)
	  Если ИмяСобытия = "ДлительнаяОперацияЗавершена" Тогда
        
        Результат = Параметр.Результат;
        Если Результат.КодСостояния = "Выполнено" Тогда
            
            
            СтруктураРезультата = Результат.ДополнительныеСвойства.Результат;
            
            Сообщить("Создано актов: " + СтруктураРезультата.КоличествоСозданных);
        Иначе
            Сообщить("Ошибка при выполнении: " + Результат.ТекстОшибки);
        КонецЕсли;
        
    КонецЕсли;
КонецПроцедуры



&НаКлиенте
Процедура СоздатьАкты(Команда)
	
    
    Если Не ЗначениеЗаполнено(Объект.Период) Тогда
        Сообщить("Укажите месяц формирования актов.");
        Возврат;
    КонецЕсли;
    
    
    ПараметрыВыполнения = Новый Структура;
    ПараметрыВыполнения.Вставить("Период", Объект.Период);
    
    
    МассивДоговоров = Новый Массив;
    Для Каждого Строка Из Объект.СписокДоговоров Цикл
        Если Не ЗначениеЗаполнено(Строка.Реализация) Тогда
            МассивДоговоров.Добавить(Строка.Договор);
        КонецЕсли;
    КонецЦикла;
    
    Если МассивДоговоров.Количество() = 0 Тогда
        Сообщить("Все акты за указанный период уже созданы.");
        Возврат;
    КонецЕсли;
    
    ПараметрыВыполнения.Вставить("Договоры", МассивДоговоров);
    
    
    АдресХранилища = ПоместитьВоВременноеХранилище(ПараметрыВыполнения, УникальныйИдентификатор);
    
   
    ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(ЭтотОбъект);
    
    ПараметрыВыполненияФункции = Новый Структура;
    ПараметрыВыполненияФункции.Вставить("АдресХранилища", АдресХранилища);
    
    
    ДлительныеОперацииКлиент.ВыполнитьФункцию(
        "Обработка.МассовоеСозданиеАктов.СоздатьАктыВФоне",
        ПараметрыВыполненияФункции,
        ПараметрыОжидания,
        "Создание актов по абонентским договорам");
    
КонецПроцедуры


&НаКлиенте
Процедура ЗаполнитьПоДоговорам(Команда)
	ЗаполнитьПоДоговорамСервер();
КонецПроцедуры	
   


&НаСервере
Процедура ЗаполнитьПоДоговорамСервер()
	   Если Не ЗначениеЗаполнено(Объект.Период) Тогда
	   	Сообщение = Новый СообщениеПользователю();
	   	Сообщение.Текст = "Укажите месяц формирования актов.";
	   	Сообщение.Сообщить();
        
        Возврат;
    КонецЕсли;
    
   
    Объект.СписокДоговоров.Очистить();
    
    
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ
    |   Договоры.Ссылка КАК Договор
    |ИЗ
    |   Справочник.ДоговорыКонтрагентов КАК Договоры
    |ГДЕ
    |   Договоры.ВидДоговора = &ВидДоговора
    |   И НЕ Договоры.ПометкаУдаления";
    
    
    Запрос.УстановитьПараметр("ВидДоговора", Перечисления.ВидыДоговоровКонтрагентов.ВКМ_АбонентскоеОбслуживание);
    
    Результат = Запрос.Выполнить();
    Выборка = Результат.Выбрать();
    
    Пока Выборка.Следующий() Цикл
        НоваяСтрока = Объект.СписокДоговоров.Добавить();
        НоваяСтрока.Договор = Выборка.Договор;
        НоваяСтрока.Реализация = НайтиСуществующуюРеализацию(Выборка.Договор, Объект.Период);
    КонецЦикла;
КонецПроцедуры

&НаСервере
Функция НайтиСуществующуюРеализацию(Договор, Период) Экспорт
    
    НачалоМесяца = НачалоМесяца(Период);
    КонецМесяца = КонецМесяца(Период);
    
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ ПЕРВЫЕ 1
    |   Реализация.Ссылка
    |ИЗ
    |   Документ.РеализацияТоваровУслуг КАК Реализация
    |ГДЕ
    |   Реализация.Договор = &Договор
    |   И Реализация.Дата МЕЖДУ &НачалоМесяца И &КонецМесяца
    |   И Реализация.Проведен";
    
    Запрос.УстановитьПараметр("Договор", Договор);
    Запрос.УстановитьПараметр("НачалоМесяца", НачалоМесяца);
    Запрос.УстановитьПараметр("КонецМесяца", КонецМесяца);
    
    Результат = Запрос.Выполнить();
    Выборка = Результат.Выбрать();
    
    Если Выборка.Следующий() Тогда
        Возврат Выборка.Ссылка;
    Иначе
        Возврат Неопределено;
    КонецЕсли;
    
КонецФункции
