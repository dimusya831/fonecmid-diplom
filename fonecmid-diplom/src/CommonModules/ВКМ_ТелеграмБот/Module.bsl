Функция ОтправитьСообщение(Текст) Экспорт

    Токен = Константы.ВКМ_ТокенТелеграмБота.Получить();
    Чат = Константы.ВКМ_ИдентификаторГруппыТелеграм.Получить();

    Если ПустаяСтрока(Токен) Или ПустаяСтрока(Чат) Тогда
        ЗаписьЖурналаРегистрации("Ошибка отправки Telegram", УровеньЖурналаРегистрации.Ошибка,,,
            "Не заданы токен или идентификатор чата");
        Возврат Ложь;
    КонецЕсли;

    
    Параметры = Новый Структура;
    Параметры.Вставить("chat_id", Чат);
    Параметры.Вставить("text", Текст);

    JSONСтрока = ЗаписатьJSON(Параметры);

    
        Попытка
        HTTPСоединение = Новый HTTPСоединение("api.telegram.org", 443,,,10); // таймаут 10 сек
        Запрос = Новый HTTPЗапрос("/bot" + Токен + "/sendMessage");
        Запрос.Заголовки.Вставить("Content-Type", "application/json");
        Запрос.УстановитьТелоИзСтроки(JSONСтрока);

        Ответ = HTTPСоединение.ВызватьHTTPМетод("POST", Запрос);

        Если Ответ.КодСостояния = 200 Тогда
           
            Возврат Истина;
        Иначе
            ТекстОшибки = "Код состояния: " + Ответ.КодСостояния + ", тело: " + Ответ.ПолучитьТелоКакСтроку();
            ЗаписьЖурналаРегистрации("Ошибка отправки Telegram", УровеньЖурналаРегистрации.Ошибка,,, ТекстОшибки);
            Возврат Ложь;
        КонецЕсли;

    Исключение
        ЗаписьЖурналаРегистрации("Ошибка отправки Telegram", УровеньЖурналаРегистрации.Ошибка,,,
            "Исключение: " + ОписаниеОшибки());
        Возврат Ложь;
    КонецПопытки;

КонецФункции

Функция ЗаписатьJSON(Объект) Экспорт

    Попытка
        Поток = Новый ПотокВПамяти;
        Запись = Новый ЗаписьJSON();
        Запись.ЗаписатьОбъект(Объект);
        Запись.Закрыть();

        Поток.Перейти(0);
        Чтение = Новый ЧтениеТекста(Поток);
        Результат = Чтение.Прочитать();
        Чтение.Закрыть();

        Возврат Результат;
    Исключение
        Возврат "{}";
    КонецПопытки;

КонецФункции