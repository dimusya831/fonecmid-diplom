
Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	
	Движения.ВКМ_ОсновныеНачисления.Записывать = Истина;
    Движения.ВКМ_ОсновныеНачисления.Очистить();
    Движения.ВКМ_ДополнительныеНачисления.Записывать = Истина;
    Движения.ВКМ_ДополнительныеНачисления.Очистить();
    Движения.ВКМ_Удержания.Записывать = Истина;
    Движения.ВКМ_Удержания.Очистить();
    Движения.ВКМ_ВзаиморасчетыССотрудниками.Записывать = Истина;
    Движения.ВКМ_ВзаиморасчетыССотрудниками.Очистить();

    
    НачалоМесяца = НачалоМесяца(МесяцНачисления);
    КонецМесяца = КонецМесяца(МесяцНачисления);


    Год = Год(НачалоМесяца);
    ДокументГрафик = Документы.ВКМ_ГрафикОтпусков.НайтиПоРеквизиту("Год", Год);
    Если ДокументГрафик.Пустая() Тогда
        Сообщить("Не найден график отпусков на год " + Год, СтатусСообщения.Внимание);
    КонецЕсли;

   
    Запрос = Новый Запрос;
    Запрос.Текст = 
        "ВЫБРАТЬ
        |	ВКМ_УсловияОплатыСотрудниковСрезПоследних.Сотрудник КАК Сотрудник,
        |	ВКМ_УсловияОплатыСотрудниковСрезПоследних.Оклад КАК Оклад,
        |	ВКМ_УсловияОплатыСотрудниковСрезПоследних.ПроцентОтРабот КАК ПроцентОтРабот
        |ИЗ
        |	РегистрСведений.ВКМ_УсловияОплатыСотрудников.СрезПоследних(&НачалоМесяца,) КАК
        |		ВКМ_УсловияОплатыСотрудниковСрезПоследних";
        
    Запрос.УстановитьПараметр("НачалоМесяца", НачалоМесяца);
    Результат = Запрос.Выполнить().Выбрать();

    Пока Результат.Следующий() Цикл
        Сотрудник = Результат.Сотрудник;
        Оклад = Результат.Оклад;
        Процент = Результат.ПроцентОтРабот;

        
        ЕстьОтпуск = Ложь;
        ДатаНачалаОтпуска = Неопределено;
        ДатаОкончанияОтпуска = Неопределено;
        Если НЕ ДокументГрафик.Пустая() Тогда
            
            НайденнаяСтрока = ДокументГрафик.ОтпускаСотрудников.Найти(Сотрудник, "Сотрудник");
            Пока НайденнаяСтрока <> Неопределено Цикл
                Если НайденнаяСтрока.ДатаНачала <= КонецМесяца И НайденнаяСтрока.ДатаОкончания >= НачалоМесяца Тогда
                    ЕстьОтпуск = Истина;
                    ДатаНачалаОтпуска = Макс(НайденнаяСтрока.ДатаНачала, НачалоМесяца);
                    ДатаОкончанияОтпуска = Мин(НайденнаяСтрока.ДатаОкончания, КонецМесяца);
                    Прервать;
                КонецЕсли;
                НайденнаяСтрока = ДокументГрафик.ОтпускаСотрудников.Найти(НайденнаяСтрока);
            КонецЦикла;
        КонецЕсли;

        
        СуммаОсновных = 0;
        Если ЕстьОтпуск Тогда
            // Расчет отпускных
            СуммаОтпускных = РассчитатьОтпускные(Сотрудник, ДатаНачалаОтпуска, ДатаОкончанияОтпуска);
            Если СуммаОтпускных > 0 Тогда
                Движение = Движения.ВКМ_ОсновныеНачисления.Добавить();
                Движение.Сотрудник = Сотрудник;
                Движение.ВидРасчета = ПланыВидовРасчета.ВКМ_ОсновныеНачисления.Отпуск;
                Движение.Результат = СуммаОтпускных;
                Движение.ПериодДействияНачало = ДатаНачалаОтпуска;
                Движение.ПериодДействияКонец = ДатаОкончанияОтпуска;
                Движение.ПериодРегистрации = Дата; 
                СуммаОсновных = СуммаОсновных + СуммаОтпускных;
            КонецЕсли;
        Иначе
            // Начисление оклада за полный месяц
            Если Оклад > 0 Тогда
                Движение = Движения.ВКМ_ОсновныеНачисления.Добавить();
                Движение.Сотрудник = Сотрудник;
                Движение.ВидРасчета = ПланыВидовРасчета.ВКМ_ОсновныеНачисления.Оклад;
                Движение.Результат = Оклад;
                Движение.ПериодДействияНачало = НачалоМесяца;
                Движение.ПериодДействияКонец = КонецМесяца;
                Движение.ПериодРегистрации = Дата;
                СуммаОсновных = СуммаОсновных + Оклад;
            КонецЕсли;
        КонецЕсли;

        
        СуммаДополнительных = 0;
        Если Процент <> 0 Тогда
            
            ЗапросРаботы = Новый Запрос;
            ЗапросРаботы.Текст = 
                "ВЫБРАТЬ
                |	ВКМ_ВыполненныеСотрудникомРаботы.СуммаКОплате КАК Сумма
                |ИЗ
                |	РегистрНакопления.ВКМ_ВыполненныеСотрудникомРаботы КАК ВКМ_ВыполненныеСотрудникомРаботы
                |ГДЕ
                |	ВКМ_ВыполненныеСотрудникомРаботы.Сотрудник = &Сотрудник
                |	И ВКМ_ВыполненныеСотрудникомРаботы.Период МЕЖДУ &НачПериода И &КонПериода";
            ЗапросРаботы.УстановитьПараметр("Сотрудник", Сотрудник);
            ЗапросРаботы.УстановитьПараметр("НачПериода", НачалоМесяца);
            ЗапросРаботы.УстановитьПараметр("КонПериода", КонецМесяца);
            Выборка = ЗапросРаботы.Выполнить().Выбрать();
            
            Если Выборка.Следующий() И Выборка.Сумма > 0 Тогда
                Движение = Движения.ВКМ_ДополнительныеНачисления.Добавить();
                Движение.Сотрудник = Сотрудник;
                Движение.ВидРасчета = ПланыВидовРасчета.ВКМ_ДополнительныеНачисления.ПроцентОтРабот;
                Движение.Результат = Выборка.Сумма;
                Движение.ПериодДействияНачало = НачалоМесяца;
                Движение.ПериодДействияКонец = КонецМесяца;
                Движение.ПериодРегистрации = Дата;
                СуммаДополнительных = СуммаДополнительных + Выборка.Сумма;
            КонецЕсли;
        КонецЕсли;

        // Расчет НДФЛ
        СуммаУдержаний = 0;
        СуммаНачислено = СуммаОсновных + СуммаДополнительных;
        Если СуммаНачислено > 0 Тогда
            СуммаНДФЛ = СуммаНачислено * 0.13;
            Движение = Движения.ВКМ_Удержания.Добавить();
            Движение.Сотрудник = Сотрудник;
            Движение.ВидРасчета = ПланыВидовРасчета.ВКМ_Удержания.НДФЛ;
            Движение.Результат = СуммаНДФЛ;
            Движение.ПериодДействияНачало = НачалоМесяца;
            Движение.ПериодДействияКонец = КонецМесяца;
            Движение.ПериодРегистрации = Дата;
            СуммаУдержаний = СуммаУдержаний + СуммаНДФЛ;
        КонецЕсли;

        // Движение по взаиморасчетам (долг предприятия)
        СуммаКВыплате = СуммаНачислено - СуммаУдержаний;
        Если СуммаКВыплате <> 0 Тогда
            Движение = Движения.ВКМ_ВзаиморасчетыССотрудниками.Добавить();
            Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
            Движение.Сотрудник = Сотрудник;
            Движение.Сумма = СуммаКВыплате;
            Движение.Период = Дата;
        КонецЕсли;

    КонецЦикла;

КонецПроцедуры

Функция РассчитатьОтпускные(Сотрудник, ДатаНачала, ДатаОкончания)

    // Период для расчета среднего: 12 месяцев до начала отпуска
    ДатаНачалаРасчета = ДобавитьМесяц(НачалоМесяца(ДатаНачала), -12);
    ДатаОкончанияРасчета = КонецМесяца(ДобавитьМесяц(ДатаНачала, -1));

    // Сумма начислений за 12 месяцев (основные + дополнительные)
    Запрос = Новый Запрос;
    Запрос.Текст = 
        "ВЫБРАТЬ
        |	СУММА(ВКМ_ОсновныеНачисления.Результат) + СУММА(ВКМ_ДополнительныеНачисления.Результат) КАК СуммаНачислений
        |ИЗ
        |	РегистрРасчета.ВКМ_ОсновныеНачисления КАК ВКМ_ОсновныеНачисления
        |		ПОЛНОЕ СОЕДИНЕНИЕ РегистрРасчета.ВКМ_ДополнительныеНачисления КАК ВКМ_ДополнительныеНачисления
        |		ПО ВКМ_ОсновныеНачисления.Сотрудник = ВКМ_ДополнительныеНачисления.Сотрудник
        |		И ВКМ_ДополнительныеНачисления.ПериодРегистрации = ВКМ_ОсновныеНачисления.ПериодРегистрации
        |ГДЕ
        |	ВКМ_ОсновныеНачисления.Сотрудник = &Сотрудник
        |	И ВКМ_ОсновныеНачисления.ПериодДействия МЕЖДУ &Нач И &Кон";
    Запрос.УстановитьПараметр("Сотрудник", Сотрудник);
    Запрос.УстановитьПараметр("Нач", ДатаНачалаРасчета);
    Запрос.УстановитьПараметр("Кон", ДатаОкончанияРасчета);
    Выборка = Запрос.Выполнить().Выбрать();
    Выборка.Следующий();
    Сумма12 = Выборка.СуммаНачислений;

    
    РабочиеДни12 = 247; 


    ДнейОтпуска = (ДатаОкончания - ДатаНачала) + 1;

    Если РабочиеДни12 = 0 Тогда
        Возврат 0;
    КонецЕсли;

    Возврат (Сумма12 / РабочиеДни12) * ДнейОтпуска;

КонецФункции
	
	

